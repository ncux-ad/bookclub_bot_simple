# Журнал изменений

## [02-08-2025] - Рефакторинг упрощенной версии
### Добавлено
- Создание модульной структуры (handlers/, services/, keyboards/)
- Улучшение безопасности с системой блокировки и валидации
- Добавление валидации данных и санитизации
- Реализация кэширования с TTL
- Система логирования с фильтрацией чувствительных данных
- Сервисы для работы с пользователями, книгами и событиями
- Главный файл приложения (main.py)
- Валидатор переменных окружения (utils/env_validator.py)
- Подробные docstrings для всех компонентов
- Пример файла конфигурации (env.example)
- Обновленная документация (README.md)
- Очистка проекта от лишних файлов
- Graceful shutdown с обработкой сигналов
- Тестовый скрипт для проверки завершения работы

### Изменено
- Реструктуризация проекта согласно принципам SOLID
- Улучшение обработки ошибок с централизованным логированием
- Оптимизация производительности через кэширование
- Интеграция сервисов в обработчики
- Конфигурация с автоматической валидацией переменных окружения
- Документация с подробными инструкциями по настройке
- Улучшено завершение работы бота с graceful shutdown

### Исправлено
- Устранение глобальных переменных
- Добавление docstrings на русском языке
- Улучшение типизации
- Соблюдение принципа единственной ответственности
- Удаление устаревших файлов и дублирующей документации
- Исправление ошибок в graceful shutdown
- Исправление декоратора admin_required
- Упрощение обработки сигналов
- Устранение дублирования graceful shutdown
- Добавление проверок состояния сессии и storage
- Устранение лишних сообщений об отмене операций
- Упрощение логики graceful shutdown
- Добавление обработки исключений на верхнем уровне
- Предотвращение вывода ошибок после graceful shutdown
- Улучшение отображения профиля пользователя
- Добавление кликабельного username и копируемого ID
- Добавление системы тегов для пользователей
- Добавление команды /settag для администраторов
- Интеграция FSM (Finite State Machine) для улучшения UX
- Пошаговая регистрация с FSM
- Поиск книг с FSM
- Команда /cancel для отмены операций
- Автоматическое создание пользователей при первом взаимодействии
- Система статусов пользователей (inactive/active)
- Активация пользователей после успешной авторизации
- Защита функций от неавторизованных пользователей
- Улучшенная статистика с подсчетом новых пользователей
- Команды управления пользователями (/ban, /unban, /userinfo)
- Расширенная статистика (/stats) с детальной аналитикой
- Система TODO.md для планирования развития
- Команда /users с интерактивными фильтрами и пагинацией
- Экспорт списка пользователей в CSV
- Детальная информация о пользователях с кнопками управления
- Анализ активности пользователей

## [03-08-2025] - Система контроля доступа и безопасности

### Добавлено
- Система контроля доступа (`utils/access_control.py`) с декораторами `active_user_required` и `admin_required`
- Динамическое отображение команд в `/help` в зависимости от статуса пользователя
- Обработчик неизвестных команд с предложением посмотреть `/help`
- Проверка статуса пользователя для всех команд клуба
- Отдельный роутер для обработки неизвестных команд (`handlers/unknown_handlers.py`)

### Изменено
- Команды `/books`, `/search`, `/schedule`, `/profile` теперь требуют активного статуса
- Команда `/help` показывает только доступные команды для конкретного пользователя
- Неактивные пользователи видят только `/start`, `/help`, `/register`
- Неадмины не видят административные команды в справке
- Исправлена проблема с обработкой команд: теперь все команды обрабатываются корректно

### Исправлено
- Сигнатура `error_handler` в `main.py` (убрал лишний параметр `update`)
- Обработка `None` значений в `users_export_handler` для `username` и `name`
- Устранение `TypeError` в callback-обработчиках
- Исправлена кодировка CSV экспорта (добавлен BOM для корректного отображения русских символов)
- Добавлена обработка заблокированных пользователей в командах `/start`, `/register`, `/help`
- Заблокированные пользователи не могут активироваться самостоятельно
- Добавлено логирование попыток доступа заблокированных пользователей
- Добавлена система защиты от спама для заблокированных пользователей
- Создан middleware для автоматической проверки активности заблокированных пользователей
- Добавлена команда `/spamstats` для мониторинга активности заблокированных пользователей
- **Заблокированные пользователи не получают обратной связи** - бот "зависает" для них

### Особенности безопасности
- Заблокированные пользователи превысившие лимиты не получают никаких сообщений
- Это создает впечатление что бот не работает, снижая интерес к спаму
- Логирование всех попыток доступа для мониторинга администраторами 

## [03-01-2025] - Модуль добавления книг и исправления

### Добавлено
- Команда `/addbook` для добавления книг через FSM
- Обработка ZIP архивов с FB2 файлами
- Автоматический парсинг метаданных из FB2 (название, автор, описание, жанры)
- Поддержка добавления ссылок на Яндекс.Книги, ЛитРес и аудиокниги
- Интерактивное редактирование данных книги перед добавлением
- Интеграция с системой контроля доступа (только для админов)

### Технические особенности
- Парсинг FB2 файлов с извлечением всех метаданных
- Временное хранение файлов с автоматической очисткой
- Валидация форматов файлов (ZIP, FB2)
- Подготовка для будущей конвертации в EPUB/MOBI

### Исправлено
- **Валидатор переменных окружения** - исправлена проверка формата BOT_TOKEN (теперь поддерживает 30-35 символов)
- **Загрузка .env** - перемещена в начало main.py для корректной загрузки переменных
- **FSM состояния** - исправлены состояния:
  - `waiting_for_phrase` → `waiting_for_secret_phrase`
  - `waiting_for_query` → `waiting_for_search_query`
- **Отступы в коде** - исправлены синтаксические ошибки в user_handlers.py

### Система защиты от спама

### Добавлено
- Добавлена обработка заблокированных пользователей в командах `/start`, `/register`, `/help`
- Заблокированные пользователи не могут активироваться самостоятельно
- Добавлено логирование попыток доступа заблокированных пользователей
- Добавлена система защиты от спама для заблокированных пользователей
- Создан middleware для автоматической проверки активности заблокированных пользователей
- Добавлена команда `/spamstats` для мониторинга активности заблокированных пользователей
- **Заблокированные пользователи не получают обратной связи** - бот "зависает" для них

### Особенности безопасности
- Заблокированные пользователи превысившие лимиты не получают никаких сообщений
- Это создает впечатление что бот не работает, снижая интерес к спаму
- Логирование всех попыток доступа для мониторинга администраторами 